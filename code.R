#Notice: please run codes in sequence. Objects generated by earlier scripts will serve as dependencies for subsequent analyses.####

#Prepare packges####
if (!require(meta)) {
  install.packages("meta")
  library(meta)
}

if(!require(metafor)){
  install.packages("metafor")
  library(metafor)
}

if(!require(ggplot2)){
  install.packages("ggplot2")
  library(ggplot2)
}

if(!require(tidyr)){
  install.packages("tidyr")
  library(tidyr)
}

if(!require(readxl)){
  install.packages("readxl")
  library(readxl)
}

if(!require(clubSandwich)){
  install.packages("clubSandwich")
  library(clubSandwich)
}

if(!require(dmetar)){
  install.packages("dmetar")
  library(dmetar)
}

if(!require(MuMIn)){
  install.packages("MuMIn")
  library(MuMIn)
}

if(!require(dplyr)){
  install.packages("dplyr")
  library(dplyr)
}

if(!require(cowplot)){
  install.packages("cowplot")
  library(cowplot)
}

if(!require(patchwork)){
  install.packages("patchwork")
  library(patchwork)
}

if(!require(grid)){
  install.packages("grid")
  library(grid)
}

if(!require(circlize)){
  install.packages("circlize")
  library(circlize)
}

if(!require(gridExtra)){
  install.packages("gridExtra")
  library(gridExtra)
}
#Read in dataset####

setwd("D:/Macrophyte meta project/macrophyte meta 25.3.17") #please set your own working directory :)

data<-read_xlsx("./data/data.xlsx")

cols_to_convert <- c("C_mean","C_sd","C_n",
                     "F1_mean", "F1_sd", "F1_n",
                     "F2_mean","F2_sd","F2_n",
                     "F1_F2_mean","F1_F2_sd","F1_F2_n")

data[cols_to_convert] <- lapply(data[cols_to_convert], as.numeric)

#style of plots
my_colours <- c("#EE7733", "#009988", "#EE3377")
my_shapes <- c(16, 17, 18)

#Calculation of null models####

#calculate Sd_p (pooled standard deviation of null expectation)

data$Sd_p<-sqrt((((data$F1_n-1)*(data$F1_sd)^2)+
                   ((data$F2_n)-1)*(data$F2_sd)^2)/(data$F1_n+data$F2_n-2)) 

#calculate n_p (pooled sample size)

data$n_p<-pmin(data$F1_n,data$F2_n)

#calculate j (j as weighting factors based on replicates)

data <- data %>% mutate( j = (1-(3 / (4*(F1_F2_n+n_p-2)-1))))

#calculate s (pooled standard deviation of predicted and combined factors)   

data <- data %>% mutate( s = sqrt( ( ((F1_F2_n-1)*(F1_F2_sd)^2) +((n_p)-1)*(Sd_p)^2 ) / (F1_F2_n+(n_p)-2) ))
#calculate additive null predict mean

data<- data %>% mutate(AdditiveNullModel = F1_mean+F2_mean-C_mean)

#calculate multiplicative null predict mean

data <-data %>% mutate(MultiplicativeNullModel = (F1_mean*F2_mean)/C_mean)

#calculate dominance null predict mean

data <- data %>% mutate(DominanceNullModel = ifelse(abs(F1_mean-C_mean)-abs(F2_mean-C_mean)>0, F1_mean, F2_mean))

#calculate hedges'd for additive null model
data <- data %>% mutate(HedgesdAdditive=((F1_F2_mean-AdditiveNullModel)/s)*j)

data<-data %>% mutate(HedgesdAdditive=ifelse(AdditiveNullModel-C_mean<0, -HedgesdAdditive, HedgesdAdditive))

#calculate hedges'd for multiplicative null model

data <- data %>% mutate(HedgesdMultiplicative=((F1_F2_mean-MultiplicativeNullModel)/s)*j)

data <- data %>% mutate(HedgesdMultiplicative=ifelse(MultiplicativeNullModel-C_mean<0, -HedgesdMultiplicative, HedgesdMultiplicative))

#calculate hedges'd for dominance null model

data <- data %>% mutate(HedgesdDominance=((F1_F2_mean-DominanceNullModel)/s)*j)

data<-data %>% mutate(HedgesdDominance=ifelse(DominanceNullModel-C_mean<0, -HedgesdDominance, HedgesdDominance))

#calculate VdAdditive (the variance around each interaction effect size for additive)

data$VdAdditive<-((data$F1_F2_n+(data$n_p))/(data$F1_F2_n*(data$n_p)))+
  (((data$HedgesdAdditive)^2)/(2*(data$F1_F2_n+(data$n_p))))

#calculate VdMultiplicative (the variance around each interaction effect size for multiplicative)

data$VdMultiplicative<-((data$F1_F2_n+(data$n_p))/(data$F1_F2_n*(data$n_p)))+
  (((data$HedgesdMultiplicative)^2)/(2*(data$F1_F2_n+(data$n_p))))

#calculate VdDominance (the variance around each interaction effect size for dominance)

data$VdDominance<-((data$F1_F2_n+(data$n_p))/(data$F1_F2_n*(data$n_p)))+
  (((data$HedgesdDominance)^2)/(2*(data$F1_F2_n+(data$n_p))))

#calculate confidence interval of hedges'd for additive null model

data$CIllAdditive<-data$HedgesdAdditive-1.96*sqrt(data$VdAdditive) #low limit

data$CIULAdditive<-data$HedgesdAdditive+1.96*sqrt(data$VdAdditive) #upper limit

#calculate confidence interval of hedges'd for multiplicative null model

data$CIllMultiplicative<-data$HedgesdMultiplicative-1.96*sqrt(data$VdMultiplicative)  #low limit

data$CIULMultiplicative<-data$HedgesdMultiplicative+1.96*sqrt(data$VdMultiplicative) #upper limit

#calculate confidence interval of hedges'd for multiplicative null model

data$CIllDominance<-data$HedgesdDominance-1.96*sqrt(data$VdDominance) #low limit

data$CIULDominance<-data$HedgesdDominance+1.96*sqrt(data$VdDominance) #upper limit

#remove data where each hedges d is <30 or >-30, following Jackson.(2016)
data <- data[data$HedgesdAdditive >-30 & data$HedgesdAdditive <30 &
               data$HedgesdDominance >-30 & data$HedgesdDominance <30 &
               data$HedgesdMultiplicative >-30 & data$HedgesdMultiplicative < 30, ]

#given interaction types based on additive, multiplicative and dominance null model

data<-data %>% mutate(AdditiveInteraction=case_when(CIULAdditive>0&CIllAdditive<0 ~ "Additive", 
                                                    CIULAdditive>0&CIllAdditive>0 ~ 'Synergistic', 
                                                    CIULAdditive<0&CIllAdditive<0 ~ 'Antagonistic'))

data<-data %>%  mutate(MultiplicativeInteraction=case_when(CIULMultiplicative>0&CIllMultiplicative<0 ~ "Additive", 
                                                           CIULMultiplicative>0&CIllMultiplicative>0 ~ 'Synergistic', 
                                                           CIULMultiplicative<0&CIllMultiplicative<0 ~ 'Antagonistic'))

data<-data %>%  mutate(DominanceInteraction=case_when(CIULDominance>0&CIllDominance<0 ~ "Additive", 
                                                      CIULDominance>0&CIllDominance>0 ~ 'Synergistic', 
                                                      CIULDominance<0&CIllDominance<0 ~ 'Antagonistic'))

datafull<-data

datafull <- subset(datafull, FactorPair != "not global change factor") #we exclude observations that are not involve global change stressors

#Inconsistency among null models

plot_venn <- function(type_label) {
  A <- datafull$AdditiveInteraction == type_label
  M <- datafull$MultiplicativeInteraction == type_label
  D <- datafull$DominanceInteraction == type_label
  
  fit <- euler(list(
    'Additive model' = which(A),
    'Multiplicative model' = which(M),
    'Dominance model' = which(D)
  ))
  
  p <- plot(fit,
            fills = list(fill = c("#FF9999", "#99CCFF", "#99FF99"), alpha = 0.6),
            labels = list(font = 2, cex = 1),
            edges = TRUE,
            quantities = list(cex = 1.2),
            main = paste(type_label, "results"),
            main.cex = 1)
  return(p)
}

p1 <- plot_venn("Synergistic")
p2 <- plot_venn("Additive")
p3 <- plot_venn("Antagonistic")

grid.arrange(
  grobs = list(
    arrangeGrob(p1, top = textGrob("(a)", x = unit(0, "npc"), just = "left", gp = gpar(fontsize = 20, cex=1))),
    arrangeGrob(p2, top = textGrob("(b)", x = unit(0, "npc"), just = "left", gp = gpar(fontsize = 20, cex=1))),
    arrangeGrob(p3, top = textGrob("(c)", x = unit(0, "npc"), just = "left", gp = gpar(fontsize = 20, cex=1)))
  ),
  ncol = 3
)

#Interactive effect of each observations and average interaction effect####

# Additive model
additive_data <- data.frame(
  StudyID = datafull$StudyID,
  ObservationID = datafull$ObservationID,
  Hedgesd = datafull$HedgesdAdditive,
  CIll = datafull$CIllAdditive,
  CIUL = datafull$CIULAdditive,
  model_type = "Additive model"
)

additive_data$color <- ifelse(additive_data$CIll > 0, "#EE0220", ifelse(additive_data$CIUL < 0, "#027EB6", "lightgrey"))

additive_data$ObservationID <- 1:nrow(additive_data)
min_y_offset <- 2
additive_data$y_position <- min_y_offset + as.integer(reorder(additive_data$ObservationID, additive_data$Hedgesd))

additive_data$V <- ((additive_data$CIUL - additive_data$CIll)^2 )/ 4

V <- impute_covariance_matrix(additive_data$V,
                              cluster=additive_data$StudyID,
                              r=0.6, ### assume a 0.6 correlation
                              smooth_vi = FALSE,
                              check_PD = TRUE,
                              return_list = FALSE
)

additive_model <- rma.mv(yi = Hedgesd, 
                         V = V, 
                         random = c(~1|StudyID/ObservationID),
                         data = additive_data, 
                         method = "REML")

additive_overall_effect_size <- additive_model$b
additive_ci.lb <- additive_model$ci.lb
additive_ci.ub <- additive_model$ci.ub
additive_p_value <- additive_model$pval

# Multiplicative model
multiplicative_data <- data.frame(
  StudyID = datafull$StudyID,
  ObservationID = datafull$ObservationID,
  Hedgesd = datafull$HedgesdMultiplicative,
  CIll = datafull$CIllMultiplicative,
  CIUL = datafull$CIULMultiplicative,
  model_type = "Multiplicative model"
)

multiplicative_data$color <- ifelse(multiplicative_data$CIll > 0, "#EE0220", ifelse(multiplicative_data$CIUL < 0, "#027EB6", "lightgrey"))

multiplicative_data$ObservationID <- 1:nrow(multiplicative_data)
multiplicative_data$y_position <- min_y_offset + as.integer(reorder(multiplicative_data$ObservationID, multiplicative_data$Hedgesd))

multiplicative_data$V <- ((multiplicative_data$CIUL - multiplicative_data$CIll)^2 )/ 4

V <- impute_covariance_matrix(multiplicative_data$V,
                              cluster=multiplicative_data$StudyID,
                              r=0.6, ### assume a 0.6 correlation
                              smooth_vi = FALSE,
                              check_PD = TRUE,
                              return_list = FALSE
)

multiplicative_model <- rma.mv(yi = Hedgesd, 
                               V = V, 
                               random = c(~1|StudyID/ObservationID),
                               data = multiplicative_data, 
                               method = "REML")

multiplicative_overall_effect_size <- multiplicative_model$b
multiplicative_ci.lb <- multiplicative_model$ci.lb
multiplicative_ci.ub <- multiplicative_model$ci.ub
multiplicative_p_value <- multiplicative_model$pval

# Dominance model
dominance_data <- data.frame(
  StudyID = datafull$StudyID,
  ObservationID = datafull$ObservationID,
  Hedgesd = datafull$HedgesdDominance,
  CIll = datafull$CIllDominance,
  CIUL = datafull$CIULDominance,
  model_type = "Dominance model"
)

dominance_data$color <- ifelse(dominance_data$CIll > 0, "#EE0220", ifelse(dominance_data$CIUL < 0, "#027EB6", "lightgrey"))

dominance_data$ObservationID <- 1:nrow(dominance_data)
dominance_data$y_position <- min_y_offset + as.integer(reorder(dominance_data$ObservationID, dominance_data$Hedgesd))

dominance_data$V <- ((dominance_data$CIUL - dominance_data$CIll)^2 )/ 4

V <- impute_covariance_matrix(dominance_data$V,
                              cluster=dominance_data$StudyID,
                              r=0.6, ### assume a 0.6 correlation
                              smooth_vi = FALSE,
                              check_PD = TRUE,
                              return_list = FALSE
)

dominance_model <- rma.mv(yi = Hedgesd, 
                          V = V, 
                          random = c(~1|StudyID/ObservationID),
                          data = dominance_data, 
                          method = "REML")

dominance_overall_effect_size <- dominance_model$b
dominance_ci.lb <- dominance_model$ci.lb
dominance_ci.ub <- dominance_model$ci.ub
dominance_p_value <- dominance_model$pval

combined_data <- rbind(additive_data, multiplicative_data, dominance_data)

overall_effects <- data.frame(
  model_type = c("Additive model", "Multiplicative model", "Dominance model"),
  overall_effect_size = c(additive_overall_effect_size, multiplicative_overall_effect_size, dominance_overall_effect_size),
  ci.lb = c(additive_ci.lb, multiplicative_ci.lb, dominance_ci.lb),
  ci.ub = c(additive_ci.ub, multiplicative_ci.ub, dominance_ci.ub),
  p_value = c(additive_p_value, multiplicative_p_value, dominance_p_value)
)

overall_effects$model_type <- as.factor(overall_effects$model_type)

levels(overall_effects$model_type) <- c("Additive model", "Multiplicative model", "Dominance model")

combined_data$model_type <- factor(combined_data$model_type, 
                                   levels = c("Additive model", "Multiplicative model", "Dominance model"))
#plot
combined_plot <- ggplot() +
  geom_point(data = combined_data, aes(x = Hedgesd, y = y_position, color = color), size = 1, shape = 18) +
  geom_errorbarh(data = combined_data, 
                 aes(xmin = CIll, xmax = CIUL, y = y_position, color = color),
                 height = 0.1) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_point(data = overall_effects, 
             aes(x = overall_effect_size, y = mean(range(combined_data$y_position)), 
                 color = "#008A25"), size = 2, shape = 18) +
  geom_errorbarh(data = overall_effects, 
                 aes(xmin = ci.lb, xmax = ci.ub, y = mean(range(combined_data$y_position))), 
                 color = "#008A25", height = 0.1, size = 3) +
  geom_text(data = overall_effects, 
            aes(x = -10, 
                y = max(combined_data$y_position), 
                label = paste("d = ", round(overall_effect_size, 3), "\np = ", round(p_value, 3))),
            hjust = 0, 
            vjust = 1, 
            size = 5) +
  facet_wrap(~ model_type, ncol = 3, nrow = 1) +
  theme_bw(base_size = 16) +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank(), 
        axis.text.y = element_blank(),        
        axis.ticks.y = element_blank(),
        strip.text = element_text(size =16) ) +  
  labs(x = "Hedges'd", y = "") +
  scale_x_continuous(limits = c(-10, 10),
                     breaks = c(seq(-10, 0, 5), seq(0, 10, 5))) +
  scale_color_identity()

print(combined_plot)

#Interaction effects of each stressor pair####

#Here, we present average interaction effects in stressor pairs (n>=10)

unique_factor_pairs <- unique(datafull$FactorPair)

subset_list <- list()

for (pair in unique_factor_pairs) {
  var_name <- pair
  subset_data <- subset(datafull, FactorPair == pair)
  subset_list[[var_name]] <- subset_data
}

all_models <- list()
for (i in seq_along(subset_list)) {
  data <- subset_list[[i]]
  
  #random effect model
  AdditiveEffect <- rma(data = data, yi = HedgesdAdditive, vi = VdAdditive)
  AdditiveEffect <- coef(summary(AdditiveEffect))
  AdditiveEffect$model <- c("Additive")
  
  MultiplicativeEffect <- rma(data = data, yi = HedgesdMultiplicative, vi = VdMultiplicative)
  MultiplicativeEffect <- coef(summary(MultiplicativeEffect))
  MultiplicativeEffect$model <- c("Multiplicative")
  
  DominanceEffect <- rma(data = data, yi = HedgesdDominance, vi = VdDominance)
  DominanceEffect <- coef(summary(DominanceEffect))
  DominanceEffect$model <- c("Dominance")
  
  MixEffectModel <- rbind(AdditiveEffect, MultiplicativeEffect, DominanceEffect)
  MixEffectModel$FactorPair <- names(subset_list)[i]
  MixEffectModel$N <- nrow(data)
  MixEffectModel$model <- as.factor(MixEffectModel$model)
  levels(MixEffectModel$model) <- c("Additive", "Multiplicative","Dominance")
  
  all_models[[i]] <- MixEffectModel
}

combined_data <- do.call(rbind, all_models)

filtered_data <- combined_data[combined_data$N >= 10, ]

filtered_data <- filtered_data[order(-filtered_data$N), ]

#Heterogeneity test####

subset_list <- list()

for (pair in unique_factor_pairs) {
  var_name <- pair
  subset_data <- subset(datafull, FactorPair == pair)
  subset_list[[var_name]] <- subset_data
}

all_models <- list()
heterogeneity_list <- list()  

for (i in seq_along(subset_list)) {
  data <- subset_list[[i]]
  factor_pair <- names(subset_list)[i]  
  n_studies <- nrow(data) 
  
  
  AdditiveModel <- rma(data = data, yi = HedgesdAdditive, vi = VdAdditive)
  MultiplicativeModel <- rma(data = data, yi = HedgesdMultiplicative, vi = VdMultiplicative)
  DominanceModel <- rma(data = data, yi = HedgesdDominance, vi = VdDominance)
  
  
  AdditiveEffect <- coef(summary(AdditiveModel))
  MultiplicativeEffect <- coef(summary(MultiplicativeModel))
  DominanceEffect <- coef(summary(DominanceModel))
  
  
  AdditiveEffect$model <- "Additive"
  MultiplicativeEffect$model <- "Multiplicative"
  DominanceEffect$model <- "Dominance"
  
  
  MixEffectModel <- rbind(AdditiveEffect, MultiplicativeEffect, DominanceEffect)
  MixEffectModel$FactorPair <- factor_pair
  MixEffectModel$N <- n_studies
  MixEffectModel$model <- as.factor(MixEffectModel$model)
  
  all_models[[i]] <- MixEffectModel
  

  heterogeneity_data <- data.frame(
    FactorPair = factor_pair,
    Model = c("Additive", "Multiplicative", "Dominance"),
    I2 = c(AdditiveModel$I2, MultiplicativeModel$I2, DominanceModel$I2),
    tau2 = c(AdditiveModel$tau2, MultiplicativeModel$tau2, DominanceModel$tau2),
    Q = c(AdditiveModel$QE, MultiplicativeModel$QE, DominanceModel$QE),
    Q_p = c(AdditiveModel$QEp, MultiplicativeModel$QEp, DominanceModel$QEp),
    N = n_studies
  )
  
  heterogeneity_list[[i]] <- heterogeneity_data
}


combined_data <- do.call(rbind, all_models)
heterogeneity_test <- do.call(rbind, heterogeneity_list)  


filtered_data <- combined_data[combined_data$N >= 10, ]
filtered_data <- filtered_data[order(-filtered_data$N), ]


heterogeneity_test <- heterogeneity_test[heterogeneity_test$N >= 10, ]
heterogeneity_test <- heterogeneity_test[order(-heterogeneity_test$N), ]


print(heterogeneity_test)


create_label <- function(factor_pair, n) {
  paste0(factor_pair, " (n = ", n, ")")
}

labels <- unique(filtered_data[, c("FactorPair", "N")])
labels$label <- mapply(create_label, labels$FactorPair, labels$N)
label_mapping <- setNames(labels$label, labels$FactorPair)

ggplot(data = filtered_data, aes(model, estimate, colour = model)) + 
  geom_hline(yintercept = 0, 
             color = "lightgrey", 
             size = 1, 
             linetype = "dashed") +
  labs(x = "", y = "Hedges'd") +
  geom_point(position = position_dodge(width = 0.3), 
             aes(shape = model), 
             size = 3) +
  geom_errorbar(aes(x = model, 
                    ymin = ci.lb, 
                    ymax = ci.ub),
                width = 0.3, 
                position = position_dodge(width = 0.3), size = 1) +
  theme_cowplot(font_size = 15) +
  scale_shape_manual(values = c(16, 17, 15)) +
  scale_colour_manual(values = my_colours) +
  scale_shape_manual(values = my_shapes)+
  theme(axis.text.x = element_text(size = 15, angle = 45, hjust = 1), ,
        plot.title = element_text(size = 14,face = "bold"),  
        strip.text = element_text(size = 14, face = "bold")) +
  theme_bw(base_size = 14) +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank(),
        strip.text = element_text(face = "bold") ) +
  scale_x_discrete(labels = c("Additive", "Multiplicative","Dominance")) +
  facet_wrap(~ FactorPair, nrow = 2, ncol = 3, 
             labeller = as_labeller(label_mapping))+
  theme(legend.position = "none")

filtered_data <- combined_data[combined_data$N <= 10, ]

filtered_data <- filtered_data[order(-filtered_data$N), ]

create_label <- function(factor_pair, n) {
  paste0(factor_pair, " (n = ", n, ")")
}

labels <- unique(filtered_data[, c("FactorPair", "N")])
labels$label <- mapply(create_label, labels$FactorPair, labels$N)
label_mapping <- setNames(labels$label, labels$FactorPair)

ggplot(data = filtered_data, aes(model, estimate, colour = model)) + 
  geom_hline(yintercept = 0, color = "lightgrey", size = 1, linetype = "dashed") +
  labs(x = "", y = "Hedge's d") +
  geom_point(position = position_dodge(width = 0.3), aes(shape = model), size = 3) +
  geom_errorbar(aes(x = model, ymin = ci.lb, ymax = ci.ub),
                width = 0.3, position = position_dodge(width = 0.3), size = 1) +
  theme_cowplot(font_size = 15) +
  scale_shape_manual(values = c(16, 17, 15)) +
  scale_colour_manual(values = my_colours) +
  theme(axis.text.x = element_text(size = 15, angle = 45, hjust = 1), ,
        plot.title = element_text(size = 12),  
        strip.text = element_text(size = 12, face = "bold")) +
  theme_bw(base_size = 14) +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank(),
        strip.text = element_text(face = "bold")) +
  scale_x_discrete(labels = c("Additive", "Multiplicative","Dominance")) +
  facet_wrap(~ FactorPair, nrow = 4, ncol = 4, labeller = as_labeller(label_mapping))+
  theme(legend.position = "none")

#Interaction effects varying in stressor combinations####

pre_data_add <-  tibble(ObsID = datafull$ObservationID,
                        FactorPair = datafull$FactorPair,
                        estimate = datafull$HedgesdAdditive,
                        ci.ll = datafull$CIllAdditive,
                        ci.ul = datafull$CIULAdditive,
                        model = "Additive",
                        plant = datafull$FunctionalTraitClassification)

pre_data_dom <-  tibble(ObsID = datafull$ObservationID,
                        FactorPair = datafull$FactorPair,
                        estimate = datafull$HedgesdDominance,
                        ci.ll = datafull$CIllDominance,
                        ci.ul = datafull$CIULDominance,
                        model = "Dominance",
                        plant = datafull$FunctionalTraitClassification)

pre_data_mul <-  tibble(ObsID = datafull$ObservationID,
                        FactorPair = datafull$FactorPair,
                        estimate = datafull$HedgesdMultiplicative,
                        ci.ll = datafull$CIllMultiplicative,
                        ci.ul = datafull$CIULMultiplicative,
                        model = "Multiplicative",
                        plant = datafull$FunctionalTraitClassification)

pre_data <- bind_rows(pre_data_add,pre_data_dom,pre_data_mul)

temp_data <- table(pre_data$FactorPair)

selected_factorPair <- names(sort(temp_data, decreasing = TRUE)[1:6])

pre_data <- pre_data[pre_data$FactorPair %in% selected_factorPair, ]

set_color <- function(ci_ul, ci_ll) {
  if (ci_ul < 0) {
    return("#027EB6")
  } else if (ci_ll > 0) {
    return("#EE0220")
  } else {
    return("darkgray")
  }
}

pre_data$color <- mapply(set_color, pre_data$ci.ul, pre_data$ci.ll)

pre_data <- pre_data %>%
  group_by(FactorPair, model) %>%
  arrange(estimate) %>%
  ungroup()

factor_pairs_abbr <- c(
  "CE x CP" = "CO2 enrichment x Chemical pollutant",
  "CE x HS" = "CO2 enrichment x Hydraulic stressors",
  "CE x IS" = "CO2 enrichment x Invasive species",
  "CE x LA" = "CO2 enrichment x Light alterations",
  "CP x CP" = "Chemical pollutant x Chemical pollutant",
  "ET x CE" = "Elevated temperature x CO2 enrichment",
  "ET x CP" = "Elevated temperature x Chemical pollutant",
  "ET x LA" = "Elevated temperature x Light alterations",
  "HM x IS" = "Habitat modification x Invasive species",
  "IS x CP" = "Invasive species x Chemical pollutant",
  "IS x LA" = "Invasive species x Light alterations",
  "LA x CP" = "Light alterations x Chemical pollutant",
  "LA x HS" = "Light alterations x Hydraulic stressors",
  "LA x IS" = "Light alterations x Invasive species",
  "LA x LA" = "Light alterations x Light alterations",
  "NE x CE" = "Nutrient enrichment x CO2 enrichment",
  "NE x CP" = "Nutrient enrichment x Chemical pollutant",
  "NE x ET" = "Nutrient enrichment x Elevated temperature",
  "NE x HS" = "Nutrient enrichment x Hydraulic stressors",
  "NE x IS" = "Nutrient enrichment x Invasive species",
  "NE x LA" = "Nutrient enrichment x Light alterations",
  "NE x LB" = "Nutrient enrichment x Loss of biodiversity",
  "NE x NE" = "Nutrient enrichment x Nutrient enrichment"
)

factor_pairs_abbr <- setNames(names(factor_pairs_abbr), factor_pairs_abbr)

pre_data$FactorPair <- factor(factor_pairs_abbr[as.character(pre_data$FactorPair)])

filtered_data <- combined_data[combined_data$N >= 10, ]

filtered_data$FactorPair <- factor(factor_pairs_abbr[as.character(filtered_data$FactorPair)])

pre_data <- pre_data %>%
  group_by(FactorPair, model) %>%
  arrange(estimate) %>%
  ungroup()

pre_data$y_factor <- factor(seq_along(pre_data$estimate))
pre_data$model <- as.factor(pre_data$model)
levels(pre_data$model) <- c("Additive", "Multiplicative","Dominance")
levels(pre_data$model) <- paste(levels(pre_data$model), "model")
levels(filtered_data$model) <- paste(levels(filtered_data$model), "model")

ggplot(pre_data, aes(x = estimate, y = y_factor, color = color)) +
  geom_point(size = 3, alpha = 0.5) +
  geom_errorbar(aes(xmin = ci.ll, xmax = ci.ul), width = 0.2, alpha = 0.5) +
  geom_point(data = filtered_data, 
             aes(x = estimate, 
                 y = mean(as.numeric(pre_data$y_factor))), 
             color = "#008A25", size = 3, shape = 18) +
  geom_errorbarh(data = filtered_data, 
                 aes(xmin = ci.lb, xmax = ci.ub, 
                     y = mean(as.numeric(pre_data$y_factor))), 
                 color = "#008A25", height = 0.1, size = 3)  +
  geom_vline(xintercept = 0, linetype = "dashed") +
  facet_grid(rows = vars(FactorPair), cols = vars(model), switch = "y") +
  scale_color_identity() +
  scale_x_continuous(expand = expansion(mult = c(0.1, 0.1))) +
  labs(y = "", x = "Hedges'd") +
  scale_y_discrete(expand = expansion(mult = c(0.1, 0.1))) +
  theme_bw(base_size = 14) +
  theme(
    strip.placement = "outside",  
    strip.background = element_rect(fill ="lightgray"),
    strip.text = element_text(size = 14),
    strip.text.y.left = element_text(angle = 90),  
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.background = element_rect(fill = "white", color = NA),  
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank()
  )

#Prepare data for moderator analysis####

Moderator.data.add <- tibble(
  StudyID = datafull$StudyID,
  ObservationID = datafull$ObservationID,
  Hedgesd = datafull$HedgesdAdditive,
  Vd = datafull$VdAdditive,
  CIll = datafull$CIllAdditive,
  CIUL = datafull$CIULAdditive,
  ModelType = "Additive",
  N = datafull$SampleSize,
  TN.aq = datafull$`N(aq)Elevated(mg.L-1)`,
  TN.sed = datafull$`N(sed)Elevated(mg.g-1)`,
  Amb.Temp = datafull$`Ambient.Temperature(DegreesCelsius)`,
  TP.aq = datafull$`Background.P(aq)(mg.L-1)`,
  TP.sed = datafull$`Background.N(sed)(mg.g-1)`,
  TN.gradient = NULL,
  TP.gradient = NULL,
  Nutrient.level = NULL,
  FactorPairs = datafull$FactorPair,
  Fish = datafull$`Background.Fish.Presence(Y/N)`,
  Snail = datafull$`Background.Snails.Presence(Y/N)`,
  TempRange = datafull$SuitableTemperatureRange,
  NutrientRange = datafull$SuitableNutrientRange,
  PhotosynthesicPathway = datafull$PhotosynthesicPathway,
  CarbonUtilization = datafull$CarbonUtilizationStrategy
  )

Moderator.data.dom <- tibble(
  StudyID = datafull$StudyID,
  ObservationID = datafull$ObservationID,
  Hedgesd = datafull$HedgesdDominance,
  Vd = datafull$VdDominance,
  CIll = datafull$CIllDominance,
  CIUL = datafull$CIULDominance,
  ModelType = "Dominance",
  N = datafull$SampleSize,
  TN.aq = datafull$`N(aq)Elevated(mg.L-1)`,
  TN.sed = datafull$`N(sed)Elevated(mg.g-1)`,
  Amb.Temp = datafull$`Ambient.Temperature(DegreesCelsius)`,
  TP.aq = datafull$`Background.P(aq)(mg.L-1)`,
  TP.sed = datafull$`Background.N(sed)(mg.g-1)`,
  TN.gradient = NULL,
  TP.gradient = NULL,
  Nutrient.level = NULL,
  FactorPairs = datafull$FactorPair,
  Fish = datafull$`Background.Fish.Presence(Y/N)`,
  Snail = datafull$`Background.Snails.Presence(Y/N)`,
  TempRange = datafull$SuitableTemperatureRange,
  NutrientRange = datafull$SuitableNutrientRange,
  PhotosynthesicPathway = datafull$PhotosynthesicPathway,
  CarbonUtilization = datafull$CarbonUtilizationStrategy
  )

Moderator.data.mul <- tibble(
  StudyID = datafull$StudyID,
  ObservationID = datafull$ObservationID,
  Hedgesd = datafull$HedgesdMultiplicative,
  Vd = datafull$VdMultiplicative,
  CIll = datafull$CIllMultiplicative,
  CIUL = datafull$CIULMultiplicative,
  ModelType = "Multiplicative",
  N = datafull$SampleSize,
  TN.aq = datafull$`N(aq)Elevated(mg.L-1)`,
  TN.sed = datafull$`N(sed)Elevated(mg.g-1)`,
  Amb.Temp = datafull$`Ambient.Temperature(DegreesCelsius)`,
  TP.aq = datafull$`Background.P(aq)(mg.L-1)`,
  TP.sed = datafull$`Background.N(sed)(mg.g-1)`,
  TN.gradient = NULL,
  TP.gradient = NULL,
  Nutrient.level = NULL,
  FactorPairs = datafull$FactorPair,
  Fish = datafull$`Background.Fish.Presence(Y/N)`,
  Snail = datafull$`Background.Snails.Presence(Y/N)`,
  TempRange = datafull$SuitableTemperatureRange,
  NutrientRange = datafull$SuitableNutrientRange,
  PhotosynthesicPathway = datafull$PhotosynthesicPathway,
  CarbonUtilization = datafull$CarbonUtilizationStrategy
  )

Moderator.data <- bind_rows(
  Moderator.data.add,
  Moderator.data.dom,
  Moderator.data.mul
)


Moderator.data$Amb.Temp <- as.numeric(Moderator.data$Amb.Temp)
Moderator.data$StudyID <- as.factor(Moderator.data$StudyID)
Moderator.data$TempRange <- as.factor(Moderator.data$TempRange)
Moderator.data$NutrientRange <- as.factor(Moderator.data$NutrientRange)
Moderator.data$PhotosynthesicPathway <- as.factor(Moderator.data$PhotosynthesicPathway)
Moderator.data$CarbonUtilization <- as.factor(Moderator.data$CarbonUtilization)

#threshold of total nitrogen is 1 mg L-1
Moderator.data <- Moderator.data %>%
  mutate(TN.gradient = case_when(
    !is.na(TN.aq) & is.na(TN.sed) & TN.aq >= 1 ~ "H",
    !is.na(TN.aq) & is.na(TN.sed) & TN.aq < 1 ~ "L",
    is.na(TN.aq) & !is.na(TN.sed) & TN.sed >= 1 ~ "H",
    is.na(TN.aq) & !is.na(TN.sed) & TN.sed < 1 ~ "L",
    !is.na(TN.aq) & !is.na(TN.sed) ~ ifelse(pmin(TN.aq, TN.sed, na.rm = TRUE) >= 1, "H", "L"),
    is.na(TN.aq) & is.na(TN.sed) ~ NA_character_
  ))

#threshold of total phosphorus is 0.1 mg L-1
Moderator.data <- Moderator.data %>%
  mutate(TP.gradient = case_when(
    !is.na(TP.aq) & is.na(TP.sed) & TP.aq > 0.1 ~ "H",
    !is.na(TP.aq) & is.na(TP.sed) & TP.aq <= 0.1 ~ "L",
    is.na(TP.aq) & !is.na(TP.sed)  ~ NA_character_,
    !is.na(TP.aq) & !is.na(TP.sed) ~ ifelse(TP.aq > 0.1, "H", "L"),
    is.na(TP.aq) & is.na(TP.sed) ~ NA_character_
  ))

#Because macrophyte have different responses to N and P, we select TN to represent nutrient level, TP was empirically transformed into TN by multiply 10
Moderator.data <- Moderator.data %>%
  mutate(Nutrient.level = case_when(
    !is.na(TN.gradient) & !is.na(TP.gradient) & TN.gradient == "H" ~ "High nutrient",
    !is.na(TN.gradient) & !is.na(TP.gradient) & TN.gradient == "L" ~ "Low nutrient",
    !is.na(TN.gradient) & is.na(TP.gradient) & TN.gradient == "H" ~ "High nutrient",
    !is.na(TP.gradient) & is.na(TN.gradient) & TP.aq*10 >= 1 ~ "High nutrient",
    !is.na(TN.gradient) & is.na(TP.gradient) & TN.gradient == "L" ~ "Low nutrient",
    !is.na(TP.gradient) & is.na(TN.gradient) & TP.aq*10 < 1 ~ "Low nutrient",
    is.na(TP.aq) & is.na(TP.sed)  ~ NA_character_))

Moderator.data.add <- Moderator.data %>%
  filter(ModelType == "Additive")

Moderator.data.dom <- Moderator.data %>%
  filter(ModelType == "Dominance")

Moderator.data.mul <- Moderator.data %>%
  filter(ModelType == "Multiplicative")

#Here, wo compute co-variance matrix
V.add <- impute_covariance_matrix(Moderator.data.add$Vd,
                              cluster = Moderator.data.add$StudyID,
                              r = 0.6, 
                              smooth_vi = FALSE,
                              check_PD = TRUE)

V.dom <- impute_covariance_matrix(Moderator.data.dom$Vd,
                                  cluster = Moderator.data.dom$StudyID,
                                  r = 0.6,
                                  smooth_vi = FALSE,
                                  check_PD = TRUE)

V.mul <- impute_covariance_matrix(Moderator.data.mul$Vd,
                                  cluster = Moderator.data.mul$StudyID,
                                  r = 0.6,
                                  smooth_vi = FALSE,
                                  check_PD = TRUE)

#Moderator: fish####

#mixed effect model
full_model.add <- rma.mv(yi = Hedgesd, 
                     V = V.add,
                     data = Moderator.data.add,
                     random = c(~1|StudyID/ObservationID),
                     mods = ~ Fish -1,
                     test = "t", 
                     method = "REML")
                    

mlm.variance.distribution(full_model.add)

#we conduct a cluster-robust test to obtain confidence intervals
rob <- robust(full_model.add, cluster = StudyID,clubSandwich = TRUE)

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.add$Fish)

result_df.add <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)

full_model.add <- result_df.add
full_model.add$group <- c("Without fish", "With fish")
names(full_model.add)[names(full_model.add) == "n.Freq"] <- "n"
full_model.add$ModelType <- "Additive model"

full_model.mul <- rma.mv(yi = Hedgesd, 
                         V = V.mul,
                         data = Moderator.data.mul,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ Fish -1,
                         test = "t", 
                         method = "REML")
                        

mlm.variance.distribution(full_model.mul)

rob <- robust(full_model.mul, cluster = StudyID,clubSandwich = TRUE)

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.mul$Fish)

result_df.mul <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)

full_model.mul <- result_df.mul
full_model.mul$group <- c("Without fish", "With fish")
names(full_model.mul)[names(full_model.mul) == "n.Freq"] <- "n"
full_model.mul$ModelType <- "Multiplicative model"

full_model.dom <- rma.mv(yi = Hedgesd, 
                         V = V.dom,
                         data = Moderator.data.dom,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ Fish -1,
                         test = "t", 
                         method = "REML")
                        

mlm.variance.distribution(full_model.dom)

rob <- robust(full_model.dom, cluster = StudyID,clubSandwich = TRUE)

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.dom$Fish)

result_df.dom <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)


full_model.dom <- result_df.dom
full_model.dom$group <- c("Without fish", "With fish")
names(full_model.dom)[names(full_model.dom) == "n.Freq"] <- "n"
full_model.dom$ModelType <- "Dominance model"

fish <- bind_rows(full_model.add,full_model.dom,full_model.mul)

fish$Moderator <- "Fish"

fish

#Moderator: Ambient nutrient level####

full_model.add <- rma.mv(yi = Hedgesd, 
                         V = V.add,
                         data = Moderator.data.add,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ TN.gradient -1,
                         test = "t", 
                         method = "REML")
                        

mlm.variance.distribution(full_model.add)

rob <- robust(full_model.add, cluster = StudyID,clubSandwich = TRUE)

rob

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.add$TN.gradient)

result_df.add <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)

full_model.add <- result_df.add
full_model.add$group <- c("High nutrient", "Low nutrient")
names(full_model.add)[names(full_model.add) == "n.Freq"] <- "n"
full_model.add$ModelType <- "Additive model"

full_model.mul <- rma.mv(yi = Hedgesd, 
                         V = V.mul,
                         data = Moderator.data.mul,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ TN.gradient -1,
                         test = "t", 
                         method = "REML")
                        

mlm.variance.distribution(full_model.mul)

rob <- robust(full_model.mul, cluster = StudyID,clubSandwich = TRUE)

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.mul$TN.gradient)

result_df.mul <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)

full_model.mul <- result_df.mul
full_model.mul$group <- c("High nutrient", "Low nutrient")
names(full_model.mul)[names(full_model.mul) == "n.Freq"] <- "n"
full_model.mul$ModelType <- "Multiplicative model"

full_model.dom <- rma.mv(yi = Hedgesd, 
                         V = V.dom,
                         data = Moderator.data.dom,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ TN.gradient -1,
                         test = "t", 
                         method = "REML")
                         

mlm.variance.distribution(full_model.dom)

rob <- robust(full_model.dom, cluster = StudyID,clubSandwich = TRUE)

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.dom$TN.gradient)

result_df.dom <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)

full_model.dom <- result_df.dom
full_model.dom$group <- c("High nutrient", "Low nutrient")
names(full_model.dom)[names(full_model.dom) == "n.Freq"] <- "n"
full_model.dom$ModelType <- "Dominance model"

Nutrient <- bind_rows(full_model.add,full_model.dom,full_model.mul)
Nutrient$Moderator <- "Nutrient"

Nutrient

#Moderator: Snail####

full_model.add <- rma.mv(yi = Hedgesd, 
                         V = V.add,
                         data = Moderator.data.add,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ Snail -1,
                         test = "t", 
                         method = "REML")


mlm.variance.distribution(full_model.add)

rob <- robust(full_model.add, cluster = StudyID,clubSandwich = TRUE)

rob

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.add$Snail)

result_df.add <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)

full_model.add <- result_df.add
full_model.add$group <- c("Without snail", "With snail")
names(full_model.add)[names(full_model.add) == "n.Freq"] <- "n"
full_model.add$ModelType <- "Additive model"

full_model.mul <- rma.mv(yi = Hedgesd, 
                         V = V.mul,
                         data = Moderator.data.mul,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ Snail -1,
                         test = "t", 
                         method = "REML")


mlm.variance.distribution(full_model.mul)

rob <- robust(full_model.mul, cluster = StudyID,clubSandwich = TRUE)

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.mul$Snail)

result_df.mul <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)

full_model.mul <- result_df.mul
full_model.mul$group <- c("Without snail", "With snail")
names(full_model.mul)[names(full_model.mul) == "n.Freq"] <- "n"
full_model.mul$ModelType <- "Multiplicative model"

full_model.dom <- rma.mv(yi = Hedgesd, 
                         V = V.dom,
                         data = Moderator.data.dom,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ Snail -1,
                         test = "t", 
                         method = "REML")


mlm.variance.distribution(full_model.dom)

rob <- robust(full_model.dom, cluster = StudyID,clubSandwich = TRUE)

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.dom$Snail)

result_df.dom <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)

full_model.dom <- result_df.dom
full_model.dom$group <- c("Without snail", "With snail")
names(full_model.dom)[names(full_model.dom) == "n.Freq"] <- "n"
full_model.dom$ModelType <- "Dominance model"

Snail <- bind_rows(full_model.add,full_model.dom,full_model.mul)
Snail$Moderator <- "Snail"

Snail

#Moderator: Ambient temperature####

full_model.add <- rma.mv(yi = Hedgesd, 
                         V = V.add,
                         data = Moderator.data.add,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ Amb.Temp,
                         test = "t", 
                         method = "REML")

mlm.variance.distribution(full_model.add)

rob <- robust(full_model.add, cluster = StudyID,clubSandwich = TRUE)

rob

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub

result_df.add <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval
)

full_model.add <- result_df.add
full_model.add$group <- c("Intercept", "Temperature")
names(full_model.add)[names(full_model.add) == "n.Freq"] <- "n"
full_model.add$ModelType <- "Additive model"


full_model.mul <- rma.mv(yi = Hedgesd, 
                         V = V.mul,
                         data = Moderator.data.mul,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ Amb.Temp,
                         test = "t", 
                         method = "REML")

mlm.variance.distribution(full_model.mul)

rob <- robust(full_model.mul, cluster = StudyID,clubSandwich = TRUE)

rob

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub

result_df.mul <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval
)

full_model.mul <- result_df.mul
full_model.mul$group <- c("Intercept", "Temperature")
names(full_model.mul)[names(full_model.mul) == "n.Freq"] <- "n"
full_model.mul$ModelType <- "Multiplicative model"


full_model.dom <- rma.mv(yi = Hedgesd, 
                         V = V.dom,
                         data = Moderator.data.dom,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ Amb.Temp,
                         test = "t", 
                         method = "REML")

mlm.variance.distribution(full_model.dom)

rob <- robust(full_model.dom, cluster = StudyID,clubSandwich = TRUE)

rob

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub

result_df.dom <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval
)

full_model.dom <- result_df.dom
full_model.dom$group <- c("Intercept", "Temperature")
names(full_model.dom)[names(full_model.dom) == "n.Freq"] <- "n"
full_model.dom$ModelType <- "Dominance model"

Temperature <- bind_rows(full_model.add,full_model.dom,full_model.mul)
Temperature$Moderator <- "Temperature"

Temperature

#Moderator: Suitable temperature range####

Moderator.data.add.Temprange <- Moderator.data.add[grepl("temperature", Moderator.data.add$FactorPairs, ignore.case = TRUE), ]
Moderator.data.mul.Temprange <- Moderator.data.mul[grepl("temperature", Moderator.data.mul$FactorPairs, ignore.case = TRUE), ]
Moderator.data.dom.Temprange <- Moderator.data.dom[grepl("temperature", Moderator.data.dom$FactorPairs, ignore.case = TRUE), ]

V.add <- impute_covariance_matrix(Moderator.data.add.Temprange$Vd,
                                  cluster = Moderator.data.add.Temprange$StudyID,
                                  r = 0.6,
                                  smooth_vi = FALSE,
                                  check_PD = TRUE)

V.dom <- impute_covariance_matrix(Moderator.data.dom.Temprange$Vd,
                                  cluster = Moderator.data.dom.Temprange$StudyID,
                                  r = 0.6,
                                  smooth_vi = FALSE,
                                  check_PD = TRUE)

V.mul <- impute_covariance_matrix(Moderator.data.mul.Temprange$Vd,
                                  cluster = Moderator.data.mul.Temprange$StudyID,
                                  r = 0.6,
                                  smooth_vi = FALSE,
                                  check_PD = TRUE)

full_model.add <- rma.mv(yi = Hedgesd, 
                         V = V.add,
                         data = Moderator.data.add.Temprange,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ TempRange-1,
                         test = "t", 
                         method = "REML")

mlm.variance.distribution(full_model.add)

rob <- robust(full_model.add, cluster = StudyID,clubSandwich = TRUE)

rob

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.add.Temprange$TempRange)

result_df.add <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)

full_model.add <- result_df.add
full_model.add$group <- c("Warm tolerant", "Not warm tolerant")
names(full_model.add)[names(full_model.add) == "n.Freq"] <- "n"
full_model.add$ModelType <- "Additive model"


full_model.mul <- rma.mv(yi = Hedgesd, 
                         V = V.mul,
                         data = Moderator.data.mul.Temprange,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ TempRange -1,
                         test = "t", 
                         method = "REML")

mlm.variance.distribution(full_model.mul)

rob <- robust(full_model.mul, cluster = StudyID,clubSandwich = TRUE)

rob

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.mul.Temprange$TempRange)

result_df.mul <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)

full_model.mul <- result_df.mul
full_model.mul$group <- c("Warm tolerant", "Not warm tolerant")
names(full_model.mul)[names(full_model.mul) == "n.Freq"] <- "n"
full_model.mul$ModelType <- "Multiplicative model"


full_model.dom <- rma.mv(yi = Hedgesd, 
                         V = V.dom,
                         data = Moderator.data.dom.Temprange,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ TempRange -1,
                         test = "t", 
                         method = "REML")

mlm.variance.distribution(full_model.dom)

rob <- robust(full_model.dom, cluster = StudyID,clubSandwich = TRUE)

rob

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.dom.Temprange$TempRange)

result_df.dom <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)

full_model.dom <- result_df.dom
full_model.dom$group <- c("Warm tolerant", "Not warm tolerant")
names(full_model.dom)[names(full_model.dom) == "n.Freq"] <- "n"
full_model.dom$ModelType <- "Dominance model"

TempRange <- bind_rows(full_model.add,full_model.dom,full_model.mul)
TempRange$Moderator <- "Suitable temperature range"

TempRange

#Moderator: Suitable nutrient range####

V.add <- impute_covariance_matrix(Moderator.data.add$Vd,
                                  cluster = Moderator.data.add$StudyID,
                                  r = 0.6,
                                  smooth_vi = FALSE,
                                  check_PD = TRUE)

V.dom <- impute_covariance_matrix(Moderator.data.dom$Vd,
                                  cluster = Moderator.data.dom$StudyID,
                                  r = 0.6,
                                  smooth_vi = FALSE,
                                  check_PD = TRUE)

V.mul <- impute_covariance_matrix(Moderator.data.mul$Vd,
                                  cluster = Moderator.data.mul$StudyID,
                                  r = 0.6,
                                  smooth_vi = FALSE,
                                  check_PD = TRUE)


full_model.add <- rma.mv(yi = Hedgesd, 
                         V = V.add,
                         data = Moderator.data.add,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ NutrientRange-1,
                         test = "t", 
                         method = "REML")

mlm.variance.distribution(full_model.add)

rob <- robust(full_model.add, cluster = StudyID,clubSandwich = TRUE)

rob

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.add$NutrientRange)

result_df.add <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)

full_model.add <- result_df.add
full_model.add$group <- c("Eutrophic sensitive", "Eutrophic tolerant")
names(full_model.add)[names(full_model.add) == "n.Freq"] <- "n"
full_model.add$ModelType <- "Additive model"


full_model.mul <- rma.mv(yi = Hedgesd, 
                         V = V.mul,
                         data = Moderator.data.mul,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ NutrientRange -1,
                         test = "t", 
                         method = "REML")

mlm.variance.distribution(full_model.mul)

rob <- robust(full_model.mul, cluster = StudyID,clubSandwich = TRUE)

rob

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.mul$NutrientRange)

result_df.mul <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)

full_model.mul <- result_df.mul
full_model.mul$group <- c("Eutrophic sensitive", "Eutrophic tolerant")
names(full_model.mul)[names(full_model.mul) == "n.Freq"] <- "n"
full_model.mul$ModelType <- "Multiplicative model"


full_model.dom <- rma.mv(yi = Hedgesd, 
                         V = V.dom,
                         data = Moderator.data.dom,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ NutrientRange -1,
                         test = "t", 
                         method = "REML")

mlm.variance.distribution(full_model.dom)

rob <- robust(full_model.dom, cluster = StudyID,clubSandwich = TRUE)

rob

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.dom$NutrientRange)

result_df.dom <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)

full_model.dom <- result_df.dom
full_model.dom$group <- c("Eutrophic sensitive", "Eutrophic tolerant")
names(full_model.dom)[names(full_model.dom) == "n.Freq"] <- "n"
full_model.dom$ModelType <- "Dominance model"

NutrientRange <- bind_rows(full_model.add,full_model.dom,full_model.mul)
NutrientRange$Moderator <- "Suitable nutrient range"

NutrientRange


#Moderator: photosynthetic pathways####

V.add <- impute_covariance_matrix(Moderator.data.add$Vd,
                                  cluster = Moderator.data.add$StudyID,
                                  r = 0.6,
                                  smooth_vi = FALSE,
                                  check_PD = TRUE)

V.dom <- impute_covariance_matrix(Moderator.data.dom$Vd,
                                  cluster = Moderator.data.dom$StudyID,
                                  r = 0.6,
                                  smooth_vi = FALSE,
                                  check_PD = TRUE)

V.mul <- impute_covariance_matrix(Moderator.data.mul$Vd,
                                  cluster = Moderator.data.mul$StudyID,
                                  r = 0.6,
                                  smooth_vi = FALSE,
                                  check_PD = TRUE)

full_model.add <- rma.mv(yi = Hedgesd, 
                         V = V.add,
                         data = Moderator.data.add,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ PhotosynthesicPathway -1,
                         test = "t", 
                         method = "REML")

mlm.variance.distribution(full_model.add)

rob <- robust(full_model.add, cluster = StudyID,clubSandwich = TRUE)

rob

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.add$PhotosynthesicPathway)

result_df.add <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)

full_model.add <- result_df.add
full_model.add$group <- c("C3", "Not C3")
names(full_model.add)[names(full_model.add) == "n.Freq"] <- "n"
full_model.add$ModelType <- "Additive model"


full_model.mul <- rma.mv(yi = Hedgesd, 
                         V = V.mul,
                         data = Moderator.data.mul,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ PhotosynthesicPathway -1,
                         test = "t", 
                         method = "REML")

mlm.variance.distribution(full_model.mul)

rob <- robust(full_model.mul, cluster = StudyID,clubSandwich = TRUE)

rob

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.mul$PhotosynthesicPathway)

result_df.mul <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)

full_model.mul <- result_df.mul
full_model.mul$group <- c("C3", "Not C3")
names(full_model.mul)[names(full_model.mul) == "n.Freq"] <- "n"
full_model.mul$ModelType <- "Multiplicative model"


full_model.dom <- rma.mv(yi = Hedgesd, 
                         V = V.dom,
                         data = Moderator.data.dom,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ PhotosynthesicPathway -1,
                         test = "t", 
                         method = "REML")

mlm.variance.distribution(full_model.dom)

rob <- robust(full_model.dom, cluster = StudyID,clubSandwich = TRUE)

rob

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.dom$PhotosynthesicPathway)

result_df.dom <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)

full_model.dom <- result_df.dom
full_model.dom$group <- c("C3", "Not C3")
names(full_model.dom)[names(full_model.dom) == "n.Freq"] <- "n"
full_model.dom$ModelType <- "Dominance model"

PhotosynthesticPathway <- bind_rows(full_model.add,full_model.dom,full_model.mul)
PhotosynthesticPathway$Moderator <- "Photosynthetic pathway"

PhotosynthesticPathway

#Moderator: Carbon utilization strategy####

full_model.add <- rma.mv(yi = Hedgesd, 
                         V = V.add,
                         data = Moderator.data.add,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ CarbonUtilization -1,
                         test = "t", 
                         method = "REML")

mlm.variance.distribution(full_model.add)

rob <- robust(full_model.add, cluster = StudyID,clubSandwich = TRUE)

rob

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.add$CarbonUtilization)

result_df.add <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)

full_model.add <- result_df.add
full_model.add$group <- c("Bicarbonate", "Not bicarbonate")
names(full_model.add)[names(full_model.add) == "n.Freq"] <- "n"
full_model.add$ModelType <- "Additive model"


full_model.mul <- rma.mv(yi = Hedgesd, 
                         V = V.mul,
                         data = Moderator.data.mul,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ CarbonUtilization -1,
                         test = "t", 
                         method = "REML")

mlm.variance.distribution(full_model.mul)

rob <- robust(full_model.mul, cluster = StudyID,clubSandwich = TRUE)

rob

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.mul$CarbonUtilization)

result_df.mul <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)

full_model.mul <- result_df.mul
full_model.mul$group <- c("Bicarbonate", "Not bicarbonate")
names(full_model.mul)[names(full_model.mul) == "n.Freq"] <- "n"
full_model.mul$ModelType <- "Multiplicative model"


full_model.dom <- rma.mv(yi = Hedgesd, 
                         V = V.dom,
                         data = Moderator.data.dom,
                         random = c(~1|StudyID/ObservationID),
                         mods = ~ CarbonUtilization -1,
                         test = "t", 
                         method = "REML")

mlm.variance.distribution(full_model.dom)

rob <- robust(full_model.dom, cluster = StudyID,clubSandwich = TRUE)

rob

estimate <- rob$beta
se <- rob$se
df <- rob$df
pval <- rob$pval
ci.ll <- rob$ci.lb
ci.ul <- rob$ci.ub
n <- table(Moderator.data.dom$CarbonUtilization)

result_df.dom <- data.frame(
  g = estimate,
  SE = se,
  df = df,
  "Lower CI" = ci.ll,
  "Upper CI" = ci.ul,
  p = pval,
  n = n
)

full_model.dom <- result_df.dom
full_model.dom$group <- c("Bicarbonate", "Not bicarbonate")
names(full_model.dom)[names(full_model.dom) == "n.Freq"] <- "n"
full_model.dom$ModelType <- "Dominance model"

CarbonUtilization <- bind_rows(full_model.add,full_model.dom,full_model.mul)
CarbonUtilization$Moderator <- "Carbon Utilization"

CarbonUtilization

#Moderator plot####

fish$group <- factor(fish$group,levels = c("Without fish", "With fish"))
fish$ModelType <- factor(fish$ModelType,
                             levels = c("Additive model", "Multiplicative model", "Dominance model"))

Nutrient$group <- factor(Nutrient$group,levels = c("Low nutrient", "High nutrient"))
Nutrient$ModelType <- factor(Nutrient$ModelType,
                             levels = c("Additive model", "Multiplicative model", "Dominance model"))

Snail$group <- factor(Snail$group,levels = c("Without snail", "With snail"))
Snail$ModelType <- factor(Snail$ModelType,
                         levels = c("Additive model", "Multiplicative model", "Dominance model"))

TempRange$group <- factor(TempRange$group,levels = c("Warm tolerant", "Not warm tolerant"))
TempRange$ModelType <- factor(TempRange$ModelType,
                          levels = c("Additive model", "Multiplicative model", "Dominance model"))

NutrientRange$group <- factor(NutrientRange$group,levels = c("Eutrophic sensitive", "Eutrophic tolerant"))
NutrientRange$ModelType <- factor(NutrientRange$ModelType,
                              levels = c("Additive model", "Multiplicative model", "Dominance model"))

PhotosynthesticPathway$group <- factor(PhotosynthesticPathway$group,levels = c("C3", "Not C3"))
PhotosynthesticPathway$ModelType <- factor(PhotosynthesticPathway$ModelType,
                                  levels = c("Additive model", "Multiplicative model", "Dominance model"))

CarbonUtilization$group <- factor(CarbonUtilization$group,levels = c("Bicarbonate", "Not bicarbonate"))
CarbonUtilization$ModelType <- factor(CarbonUtilization$ModelType,
                                           levels = c("Additive model", "Multiplicative model", "Dominance model"))

#Nutrient moderator plot####
x.lab.Nutrient <- paste0(
  levels(Nutrient$group),
  "\n(n = ",
  Nutrient$n[match(levels(Nutrient$group), Nutrient$group)],
  ")"
)

Nutrient.plot <- ggplot(Nutrient, aes(x = group, y = g, color = ModelType, shape = ModelType)) +
  geom_hline(yintercept = 0, color = "lightgrey", size = 1, linetype = "dashed")+
  geom_point(
    position = position_jitterdodge(
      jitter.width = 0,
      dodge.width = 0.7
    ),
    alpha = 1,
    size = 3
  ) +
  geom_errorbar(
    data = Nutrient,
    aes(ymin = Lower.CI, ymax = Upper.CI),
    width = 0.3,
    size = 1,
    position = position_dodge(width = 0.7)
  ) +
  scale_colour_manual(values = my_colours) +
  scale_shape_manual(values = my_shapes)+
  theme_minimal() +
  labs(
    x = "Moderator levels",
    y = "Hedges'd",
  ) +
  theme(
    legend.title = element_blank(),
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5)
  )+ 
  facet_wrap(~ Moderator, nrow = 1) +
  theme_bw(base_size = 14) +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank(),
        strip.text = element_text(size = 14))+
  theme(legend.position = "none")+
  scale_x_discrete(labels = x.lab.Nutrient)

Nutrient.plot

#Fish moderator plot####

x.lab.fish <- paste0(
  levels(fish$group),
  "\n(n = ",
  fish$n[match(levels(fish$group), fish$group)],
  ")"
)

Fish.plot <- ggplot(fish, aes(x = group, y = g, color = ModelType, shape = ModelType)) +
  geom_hline(yintercept = 0, color = "lightgrey", size = 1, linetype = "dashed")+
  geom_point(
    position = position_jitterdodge(
      jitter.width = 0,
      dodge.width = 0.7
    ),
    alpha = 1,
    size = 3
  ) +
  geom_errorbar(
    data = fish,
    aes(ymin = Lower.CI, ymax = Upper.CI),
    width = 0.3,
    size = 1,
    position = position_dodge(width = 0.7)
  ) +
  scale_color_manual(values = my_colours) +
  scale_shape_manual(values = my_shapes) +
  theme_minimal() +
  labs(
    x = "Moderator levels",
    y = "Hedges'd",
  ) +
  theme(
    legend.title = element_blank(),
    legend.position = "none",
    plot.title = element_text(hjust = 0.5)
  )+ 
  facet_wrap(~ Moderator, nrow = 1) +
  theme_bw(base_size = 14) +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank(),
        strip.text = element_text(size = 14))+
  theme(legend.position = "none")+
  scale_x_discrete(labels = x.lab.fish)

Fish.plot

#Snail moderator plot####

x.lab.Snail <- paste0(
  levels(Snail$group),
  "\n(n = ",
  Snail$n[match(levels(Snail$group), Snail$group)],
  ")"
)

Snail.plot <- ggplot(Snail, aes(x = group, y = g, color = ModelType, shape = ModelType)) +
  geom_hline(yintercept = 0, color = "lightgrey", size = 1, linetype = "dashed")+
  geom_point(
    position = position_jitterdodge(
      jitter.width = 0,
      dodge.width = 0.7
    ),
    alpha = 1,
    size = 3
  ) +
  geom_errorbar(
    data = Snail,
    aes(ymin = Lower.CI, ymax = Upper.CI),
    width = 0.3,
    size = 1,
    position = position_dodge(width = 0.7)
  ) +
  scale_color_manual(values = my_colours) +
  scale_shape_manual(values = my_shapes) +
  theme_minimal() +
  labs(
    x = "Moderator levels",
    y = "Hedges'd",
  ) +
  theme(
    legend.title = element_blank(),
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5)
  )+ 
  facet_wrap(~ Moderator, nrow = 1) +
  theme_bw(base_size = 14) +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank(),
        strip.text = element_text(size = 14))+
  theme(legend.position = "none")+
  scale_x_discrete(labels = x.lab.Snail)

Snail.plot

#TempRange moderator plot####

x.lab.TempRange <- paste0(
  levels(TempRange$group),
  "\n(n = ",
  TempRange$n[match(levels(TempRange$group), TempRange$group)],
  ")"
)

TempRange.plot <- ggplot(TempRange, aes(x = n.Var1, y = g, color = ModelType, shape = ModelType)) +
  geom_hline(yintercept = 0, color = "lightgrey", size = 1, linetype = "dashed")+
  geom_point(
    position = position_jitterdodge(
      jitter.width = 0,
      dodge.width = 0.7
    ),
    alpha = 1,
    size = 3
  ) +
  geom_errorbar(
    data = TempRange,
    aes(ymin = Lower.CI, ymax = Upper.CI),
    width = 0.3,
    size = 1,
    position = position_dodge(width = 0.7)
  ) +
  scale_color_manual(values = my_colours) +
  scale_shape_manual(values = my_shapes) +
  theme_minimal() +
  labs(
    x = "Moderator levels",
    y = "Hedges'd",
  ) +
  theme(
    legend.title = element_blank(),
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5,size = 14)
  )+ 
  facet_wrap(~ Moderator, nrow = 1) +
  theme_bw(base_size = 14) +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank(),
        strip.text = element_text(size = 14))+
  scale_x_discrete(labels = x.lab.TempRange)+
  #ggtitle("Elevated temperature x other stressors (n=43)") +
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.position = "none")

TempRange.plot

#NutrientRange moderator plot####

x.lab.NutrientRange <- paste0(
  levels(NutrientRange$group),
  "\n(n = ",
  NutrientRange$n[match(levels(NutrientRange$group), NutrientRange$group)],
  ")"
)

NutrientRange.plot <- ggplot(NutrientRange, aes(x = n.Var1, y = g, color = ModelType, shape = ModelType)) +
  geom_hline(yintercept = 0, color = "lightgrey", size = 1, linetype = "dashed")+
  geom_point(
    position = position_jitterdodge(
      jitter.width = 0,
      dodge.width = 0.7
    ),
    alpha = 1,
    size = 3
  ) +
  geom_errorbar(
    data = NutrientRange,
    aes(ymin = Lower.CI, ymax = Upper.CI),
    width = 0.3,
    size = 1,
    position = position_dodge(width = 0.7)
  ) +
  scale_color_manual(values = my_colours) +
  scale_shape_manual(values = my_shapes) +
  theme_minimal() +
  labs(
    x = "Moderator levels",
    y = "Hedges'd",
  ) +
  theme(
    legend.title = element_blank(),
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5)
  )+ 
  facet_wrap(~ Moderator, nrow = 1) +
  theme_bw(base_size = 14) +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank(),
        strip.text = element_text(size = 14))+
  scale_x_discrete(labels = x.lab.NutrientRange)+
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = "none")

NutrientRange.plot

#PhotosyntheticPathway moderator plot####

x.lab.PhotosynthesticPathway <- paste0(
  levels(PhotosynthesticPathway$group),
  "\n(n = ",
  PhotosynthesticPathway$n[match(levels(PhotosynthesticPathway$group), PhotosynthesticPathway$group)],
  ")"
)

PhotosynthesticPathway.plot <- ggplot(PhotosynthesticPathway, aes(x = n.Var1, y = g, color = ModelType, shape = ModelType)) +
  geom_hline(yintercept = 0, color = "lightgrey", size = 1, linetype = "dashed")+
  geom_point(
    position = position_jitterdodge(
      jitter.width = 0,
      dodge.width = 0.7
    ),
    alpha = 1,
    size = 3
  ) +
  geom_errorbar(
    data = PhotosynthesticPathway,
    aes(ymin = Lower.CI, ymax = Upper.CI),
    width = 0.3,
    size = 1,
    position = position_dodge(width = 0.7)
  ) +
  scale_color_manual(values = my_colours) +
  scale_shape_manual(values = my_shapes) +
  theme_minimal() +
  labs(
    x = "Moderator levels",
    y = "Hedges'd",
  ) +
  theme(
    legend.title = element_blank(),
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5)
  )+ 
  facet_wrap(~ Moderator, nrow = 1) +
  theme_bw(base_size = 14) +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank(),
        strip.text = element_text(size = 14))+
  scale_x_discrete(labels = x.lab.PhotosynthesticPathway)+
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = "none")

PhotosynthesticPathway.plot

#CarbonUtilization moderator plot####

x.lab.CarbonUtilization <- paste0(
  levels(CarbonUtilization$group),
  "\n(n = ",
  CarbonUtilization$n[match(levels(CarbonUtilization$n.Var1), CarbonUtilization$n.Var1)],
  ")"
)

CarbonUtilization.plot <- ggplot(CarbonUtilization, aes(x = n.Var1, y = g, color = ModelType, shape = ModelType)) +
  geom_hline(yintercept = 0, color = "lightgrey", size = 1, linetype = "dashed")+
  geom_point(
    position = position_jitterdodge(
      jitter.width = 0,
      dodge.width = 0.7
    ),
    alpha = 1,
    size = 3
  ) +
  geom_errorbar(
    data = CarbonUtilization,
    aes(ymin = Lower.CI, ymax = Upper.CI),
    width = 0.3,
    size = 1,
    position = position_dodge(width = 0.7)
  ) +
  scale_color_manual(values = my_colours) +
  scale_shape_manual(values = my_shapes) +
  theme_minimal() +
  labs(
    color = "Null models",
    shape = "Null models",
    x = "Moderator levels",
    y = "Hedges'd"
  ) +
  theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 16),
  )+ 
  facet_wrap(~ Moderator, nrow = 1) +
  theme_bw(base_size = 14) +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank(),
        legend.direction = "vertical",
        strip.text = element_text(size = 14))+
  scale_x_discrete(labels = x.lab.CarbonUtilization)+
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = "none")

CarbonUtilization.plot

g_legend <- function(a.gplot) {
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)
}

legend <- g_legend(CarbonUtilization.plot + theme(legend.position = "top"))

#combined moderator plot

grid.arrange(arrangeGrob(TempRange.plot, NutrientRange.plot, 
                         PhotosynthesticPathway.plot, CarbonUtilization.plot, 
                         Nutrient.plot, Fish.plot, Snail.plot,legend,
                         nrow = 4, ncol = 2))

library(ggplot2)
library(grid)
library(gridExtra)

plot_list <- list(
  TempRange.plot, NutrientRange.plot,
  PhotosynthesticPathway.plot, CarbonUtilization.plot,
  Nutrient.plot, Fish.plot, Snail.plot,
  nullGrob())

grob_list <- lapply(plot_list, function(x) {
  if (inherits(x, "ggplot")) {
    ggplotGrob(x)
  } else if (inherits(x, "grob") || inherits(x, "gtable")) {
    x
  } else {
    stop("Unknown plot object: must be ggplot/grob/gtable")
  }
})

main_plots <- arrangeGrob(
  grobs = grob_list,
  nrow  = 4,
  ncol  = 2
)

legend_grob <- if (inherits(legend, "grob")) {
  legend
} else {
  do.call(grobTree, legend)
}

full <- arrangeGrob(
  main_plots,
  legend_grob,
  nrow    = 2,
  heights = unit.c(unit(0.95, "npc"), unit(0.05, "npc"))
)

grid.newpage()
grid.draw(full)

grid.rect(
  x      = 0.5, y = 0.8,
  width  = 0.99, height = 0.5,
  gp     = gpar(col="#DDD", lty="dashed", lwd=2, fill=NA)
)
grid.text(
  "Experiment condition",
  x    = unit(0.02, "npc"), y    = unit(1.2, "npc"),
  just = c("left","top"),    gp   = gpar(fontface="bold")
)

grid.rect(
  x      = 0.5, y      = 0.33,
  width  = 0.99, height = 0.46,
  gp     = gpar(col="#DDD", lty="dashed", lwd=1.5, fill=NA)
)
grid.text(
  "Plant intrinsic trait",
  x    = unit(0.02, "npc"), y    = unit(0.53, "npc"),
  just = c("left","bottom"), gp  = gpar(fontface="bold")
)


#Select model with best fitness based on AIC: model####

#Here, we construct a full model includes all potential moderators based on literature review
full_model <- rma.mv(yi = Hedgesd, 
                     V = V.add,
                     data = Moderator.data.add,
                     random = c(~1|StudyID/ObservationID),
                     mods = ~ FactorPairs + Nutrient.level + Fish + Snail + TempRange + NutrientRange + PhotosynthesicPathway + CarbonUtilization -1,
                     test = "t", 
                     method = "REML"
                     )


eval(metafor:::.MuMIn)

rankings <- dredge(full_model)

subset.additive <- subset(rankings, delta <= 10, recalc.weights=FALSE)

rank_df <- as.data.frame(subset(rankings, delta <= 10, recalc.weights=FALSE))

sw(rankings)

sw_r <- as.data.frame(sw(rankings))

sw_r$Variables <- c("Nutrient level", "Factor pair", "Carbon utilization strategy",
                    "Snail", "Fish","Suitable nutrient range", "Photosynthesic pathway", "Suitable temperature range")

colnames(sw_r)[1]<- "Value"

sw_r$model <- "Additive model"

sw_r.add <- sw_r

Additive.plot <- ggplot(data=sw_r, aes(x=reorder(Variables,-Value), y=Value))+
  geom_bar(stat = "identity", width= 0.7)+
  xlab("Moderator variables")+ ylab("Relative importance\n")+
  theme_classic()+
  theme(axis.title.x = element_text(face="bold", colour="black", size=16),
        axis.text.x  = element_text(vjust=0.1, size=15),
        axis.title.y = element_text(face="bold", colour="black", size=16),
        axis.text.y  = element_text(vjust=0.1, size=15),
        axis.line = element_line(colour = 'black', size = 1),
        plot.margin = unit(c(5, 5, 10, 10), "pt"))+
  theme_bw() +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank())+
  ggtitle("Additive model")+
  theme(plot.title = element_text(hjust = 0.5))

Additive.plot

full_model <- rma.mv(yi = Hedgesd, 
                     V = V.dom,
                     data = Moderator.data.dom,
                     random = c(~1|StudyID/ObservationID),
                     mods = ~ FactorPairs + Nutrient.level + Fish + Snail + TempRange + NutrientRange + PhotosynthesicPathway + CarbonUtilization-1,
                     test = "t", 
                     method = "REML"
)


eval(metafor:::.MuMIn)

rankings <- dredge(full_model)

subset(rankings, delta <= 10, recalc.weights=FALSE)

subset.dominance <- subset(rankings, delta <= 10, recalc.weights=FALSE)

rank_df <- as.data.frame(subset(rankings, delta <= 10, recalc.weights=FALSE))

sw(rankings)

sw_r <- as.data.frame(sw(rankings))

sw_r$Variables <- c("Nutrient level", "Factor pair", "Carbon utilization strategy",
                    "Snail", "Fish","Suitable nutrient range", "Photosynthesic pathway", "Suitable temperature range")

colnames(sw_r)[1]<- "Value"

sw_r$model <- "Dominance model"

sw_r.dom <- sw_r

Dominance.plot <- ggplot(data=sw_r, aes(x=reorder(Variables,-Value), y=Value))+
  geom_bar(stat = "identity", width= 0.7)+
  xlab("Moderator variables")+ ylab("Relative importance\n")+
  theme_classic()+
  theme(axis.title.x = element_text(face="bold", colour="black", size=16),
        axis.text.x  = element_text(vjust=0.1, size=15),
        axis.title.y = element_text(face="bold", colour="black", size=16),
        axis.text.y  = element_text(vjust=0.1, size=15),
        axis.line = element_line(colour = 'black', size = 1),
        plot.margin = unit(c(5, 5, 10, 10), "pt"))+
  theme_bw() +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank())+
  ggtitle("Dominance model")+
  theme(plot.title = element_text(hjust = 0.5))

Dominance.plot

full_model <- rma.mv(yi = Hedgesd, 
                     V = V.mul,
                     data = Moderator.data.mul,
                     random = c(~1|StudyID/ObservationID),
                     mods = ~ FactorPairs + Nutrient.level + Fish + Snail + TempRange + NutrientRange + PhotosynthesicPathway + CarbonUtilization-1,
                     test = "t", 
                     method = "REML"
)

eval(metafor:::.MuMIn)

rankings <- dredge(full_model)

subset(rankings, delta <= 10, recalc.weights=FALSE)

subset.multiplicative <- subset(rankings, delta <= 10, recalc.weights=FALSE)

rank_df <- as.data.frame(subset(rankings, delta <= 10, recalc.weights=FALSE))

sw(rankings)

sw_r <- as.data.frame(sw(rankings))

sw_r$Variables <- c("Nutrient level", "Factor pair", "Carbon utilization strategy",
                    "Snail", "Fish","Suitable nutrient range", "Photosynthesic pathway", "Suitable temperature range")

colnames(sw_r)[1]<- "Value"

sw_r$model <- "Multiplicative model"

sw_r.mul <- sw_r

Multiplicative.plot <- ggplot(data=sw_r, aes(x=reorder(Variables,-Value), y=Value))+
  geom_bar(stat = "identity", width= 0.7)+
  xlab("Moderator variables")+ ylab("Relative importance\n")+
  theme_classic()+
  theme(axis.title.x = element_text(face="bold", colour="black", size=16),
        axis.text.x  = element_text(vjust=0.1, size=15),
        axis.title.y = element_text(face="bold", colour="black", size=16),
        axis.text.y  = element_text(vjust=0.1, size=15),
        axis.line = element_line(colour = 'black', size = 1),
        plot.margin = unit(c(5, 5, 10, 10), "pt"))+
  theme_bw() +
  theme(panel.grid.major.x = element_blank(), 
        panel.grid.minor.x = element_blank(), 
        panel.grid.major.y = element_blank(), 
        panel.grid.minor.y = element_blank())+
  ggtitle("Multiplicative model")+
  theme(plot.title = element_text(hjust = 0.5))

#Additive.plot/Multiplicative.plot/Dominance.plot

sw_r <- rbind(sw_r.add, sw_r.mul, sw_r.dom)

sw_r$model <- factor(sw_r$model, levels = c("Dominance model", "Multiplicative model", "Additive model"))

sw_r$Variables <- factor(sw_r$Variables, levels = c("Stressor pair","Nutrient level", "Snail", "Fish","Carbon utilization strategy",
                                                    "Suitable nutrient range", "Photosynthesic pathway", "Suitable temperature range"))

sw_r$Variables[is.na(sw_r$Variables)] <- "Stressor pair"

ggplot(sw_r, aes(x = Variables, y = model)) +
  geom_point(aes(size = Value, fill = model), shape = 21) +
  scale_size(
    range = c(2, 10), 
    name = "Weight",
    breaks = c(0.5, 0.75, 1),
    limits = c(0.5, 1)  
  ) +
  scale_fill_manual(
    values = c("Additive model" = "#EE7733",
               "Multiplicative model" = "#009988",
               "Dominance model" = "#EE3377"),
    guide = "none"
  ) + 
  theme_minimal(base_size = 14) +  
  theme(
    panel.grid.major = element_line(linetype = "dashed", color = "grey80", size = 0.5),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    axis.ticks.x = element_line(color = "black"),
    axis.ticks.y = element_line(color = "black"),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 14),
    axis.text.y = element_text(size = 14),
    legend.position = "top",
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 14),
    axis.title = element_blank()
  )

#Appendix:####
#This part of codes is built for showing patterns of dataset

#Single and combined effect in stressor pairs####

factors <- c("Chemical pollutant" = "CP", 
             "CO2 enrichment" = "CE", 
             "Hydraulic stressors" = "HS", 
             "Invasive species" = "IS", 
             "Light alterations" = "LA", 
             "Elevated temperature" = "ET", 
             "Nutrient enrichment" = "NE")

factor_pairs_abbr <- c(
  "CE x CP" = "CO2 enrichment x Chemical pollutant",
  "CE x HS" = "CO2 enrichment x Hydraulic stressors",
  "CE x IS" = "CO2 enrichment x Invasive species",
  "CE x LA" = "CO2 enrichment x Light alterations",
  "CP x CP" = "Chemical pollutant x Chemical pollutant",
  "ET x CE" = "Elevated temperature x CO2 enrichment",
  "ET x CP" = "Elevated temperature x Chemical pollutant",
  "ET x LA" = "Elevated temperature x Light alterations",
  "IS x CP" = "Invasive species x Chemical pollutant",
  "IS x LA" = "Invasive species x Light alterations",
  "LA x CP" = "Light alterations x Chemical pollutant",
  "LA x HS" = "Light alterations x Hydraulic stressors",
  "LA x IS" = "Light alterations x Invasive species",
  "LA x LA" = "Light alterations x Light alterations",
  "NE x CE" = "Nutrient enrichment x CO2 enrichment",
  "NE x CP" = "Nutrient enrichment x Chemical pollutant",
  "NE x ET" = "Nutrient enrichment x Elevated temperature",
  "NE x HS" = "Nutrient enrichment x Hydraulic stressors",
  "NE x IS" = "Nutrient enrichment x Invasive species",
  "NE x LA" = "Nutrient enrichment x Light alterations",
  "NE x NE" = "Nutrient enrichment x Nutrient enrichment"
)

factor_pairs_abbr <- setNames(names(factor_pairs_abbr), factor_pairs_abbr)

df <- datafull

df$M_Combined <- NA
df$Se_Combined <- NA
df$V_Combined <- NA

for (i in 1:nrow(df)) {
  F1_mean <- df[i, "F1_mean"]
  F2_mean <- df[i, "F2_mean"]
  F1_F2_mean <- df[i, "F1_F2_mean"]
  C_mean <- df[i, "C_mean"]
  j <- df[i, "j"]
  s <- df[i, "s"]

  factor_one <- as.character(df$FactorOneType[i])
  factor_two <- as.character(df$FactorTwoType[i])

  if (factor_one %in% names(factors)) {
    code <- factors[factor_one]
    df[i, paste0("M_Solo_", code)] <- ((F1_mean - C_mean) * j) / (2 * s)
    df[i, paste0("Se_Solo_", code)] <- df[i, "F1_sd"] / sqrt(df[i, "F1_n"])
  }
  
  if (factor_two %in% names(factors)) {
    code <- factors[factor_two]
    df[i, paste0("M_Solo_", code)] <- ((F2_mean - C_mean) * j) / (2 * s)
    df[i, paste0("Se_Solo_", code)] <- df[i, "F2_sd"] / sqrt(df[i, "F2_n"])
  }

    df[i, "M_Combined"] <- ((F1_F2_mean - C_mean) * j) / (2 * s)
    df[i, "Se_Combined"] <- df[i, "F1_F2_sd"] / sqrt(df[i, "F1_F2_n"])
}

pre_df <- data.frame(
  FactorPair = character(),
  EffectType = character(),
  Factor = character(),
  Estimate = numeric(),
  SE = numeric(),
  CI_lower = numeric(),
  CI_upper = numeric(),
  k = numeric(),
  stringsAsFactors = FALSE
)

for (pair in unique(df$FactorPair)) {
  pair_data <- df[df$FactorPair == pair, ]
  factors_in_pair <- unlist(strsplit(pair, " x "))
  
  for (factor in factors_in_pair) {
    code <- factors[factor]
    yi <- pair_data[[paste0("M_Solo_", code)]]
    sei <- pair_data[[paste0("Se_Solo_", code)]]
    
    if (length(na.omit(yi)) > 8) {
      
      res <- rma(yi = yi, sei = sei, method = "REML")
      
      pre_df <- rbind(pre_df, data.frame(
        FactorPair = pair,
        EffectType = "Solo",
        Factor = factor,
        Estimate = res$beta[1],
        SE = res$se,
        CI_lower = res$ci.lb,
        CI_upper = res$ci.ub,
        k = res$k
      ))
    }
  }
  
  yi <- pair_data[["M_Combined"]]
  sei <- pair_data[["Se_Combined"]]
  
  if (length(na.omit(yi)) > 8) {
    res <- rma(yi = yi, sei = sei, method = "REML")
    
    pre_df <- rbind(pre_df, data.frame(
      FactorPair = pair,
      EffectType = "Combined",
      Factor = "Combined",
      Estimate = res$beta[1],
      SE = res$se,
      CI_lower = res$ci.lb,
      CI_upper = res$ci.ub,
      k = res$k
    ))
  }
}

my_colours <- c("#F16C23", "#2B6A99")

pre_df <- pre_df[order(pre_df$FactorPair), ]

plot_list <- list()

for (pair in unique(pre_df$FactorPair)) {
  subset_data <- pre_df[pre_df$FactorPair == pair, ]
  n <- nrow(subset_data)
  
  combined_data <- subset_data[subset_data$Factor == "Combined", ]
  other_data <- subset_data[subset_data$Factor != "Combined", ]
  other_data <- other_data[order(other_data$Factor), ]
  
  ordered_data <- rbind(other_data, combined_data)
  
  factor_levels <- unique(ordered_data$Factor)
  combined_index <- which(factor_levels == "Combined")
  if (length(combined_index) > 0) {
    factor_levels <- c(factor_levels[-combined_index], "Combined")
  }
  ordered_data$Factor <- factor(ordered_data$Factor, levels = factor_levels)

  factor_colors <- ifelse(ordered_data$Factor == "Combined", my_colours[1], my_colours[2])
  
  ordered_data$EffectType <- factor(ordered_data$EffectType, levels = c("Solo", "Combined"))
  
  p <- ggplot(data = ordered_data, aes(x = Factor, y = Estimate, colour = Factor)) + 
    geom_hline(yintercept = 0, color = "lightgrey", size = 1, linetype = "dashed") +
    labs(x = "", y = "Hedge's g") +
    geom_point(position = position_dodge(width = 0.3), aes(shape = Factor), size = 3) +
    geom_errorbar(aes(x = Factor, ymin = CI_lower, ymax = CI_upper),
                  width = 0.3, position = position_dodge(width = 0.3), size = 1) +
    theme_cowplot(font_size = 15) +
    scale_shape_manual(values = c(16, 17, 15)) +
    scale_colour_manual(values = factor_colors) +
    theme(axis.text.x = element_text(size = 15, angle = 45, hjust = 1),
          strip.text = element_text(size = 12, face = "bold")) +
    theme_bw() +
    theme(panel.grid.major.x = element_blank(), 
          panel.grid.minor.x = element_blank(), 
          panel.grid.major.y = element_blank(), 
          panel.grid.minor.y = element_blank(),
          plot.title = element_text(size = 12, hjust = 0.5)) +
    ggtitle(paste0(pair, " (n=", ordered_data$k, ")")) +
    theme(legend.position = "none")
  
  plot_list[[pair]] <- p
}

combined_plot <- wrap_plots(plot_list, nrow = 2, ncol = 3)

print(combined_plot)

#Experiment distribution####

worldmap <- map_data("world")

datamap <- datafull %>% group_by(Latitude,Longitude,Country,Habitat) %>%
  summarise(observation_count = n(),.groups = "drop")

datamap <- na.omit(datamap)

datamap$Country <- as.factor(datamap$Country)

datamap$observation_count <- as.numeric(datamap$observation_count)

datamap$Latitude <- as.numeric(datamap$Latitude)

datamap$Longitude <- as.numeric(datamap$Longitude)

main_plot <- ggplot() +
  geom_polygon(data = worldmap, aes(x = long, y = lat, group = group), fill = "#DDDDDD", alpha = 0.7, color = "#DDDDDD") +
  geom_point(data = datamap, aes(x = Longitude, y = Latitude, size = observation_count, fill = Habitat, alpha = 0.7), shape = 21, color = "black") +
  scale_fill_manual(values = c("#7383B1", "#66B282", "#FFE171")) +
  scale_size(range = c(2, 12), name = "Observation counts") +
  xlab(NULL) +
  ylab(NULL) +
  theme_cowplot() +
  theme(axis.line = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        legend.position = "none")


habitat_legend_plot <- ggplot(datamap, aes(x = Longitude, y = Latitude, fill = Habitat)) +
  geom_point(shape = 21, color = "black", size = 8) +
  scale_fill_manual(values = c("#7383B1", "#66B282", "#FFE171")) +
  guides(
    fill = guide_legend(
      override.aes = list(size = 8),
      title = "Habitat",
      title.position = "top",
      label.position = "right",
      direction = "vertical"),
    size = "none",
    alpha = 'none'
  )+
  theme(
    legend.position = "right",
    legend.background = element_blank(),  
    legend.box.background = element_blank(),  
    legend.key = element_blank(),  
    legend.key.size = unit(1, "lines")
  )

habitat_legend_grob <- ggplotGrob(habitat_legend_plot)$grobs[[which(sapply(ggplotGrob(habitat_legend_plot)$grobs, function(x) x$name == "guide-box"))]]


size_legend_plot <- ggplot(datamap, aes(x = Longitude, y = Latitude, size = observation_count)) +
  geom_point(shape = 21, color = "black", fill = "white") +
  scale_size(range = c(2, 12), name = "Observation counts",breaks = c(1,3,5)) +
  guides(size = guide_legend(
    override.aes = list(shape = 21),
    title = "Observation counts",
    title.position = "top",
    label.position = "bottom",
    direction = "horizontal",
    nrow = 1,
    label.hjust = 0.5,
    keywidth = unit(1, "cm"),
    keyheight = unit(1, "cm"),
    title.hjust = 0.5
  ),
  fill = "none",
  alpha = "none") +
  theme(
    legend.position = "right",
    legend.background = element_blank(),  
    legend.box.background = element_blank(),  
    legend.key = element_blank(),  
    legend.key.size = unit(1, "lines")
  )

size_legend_grob <- ggplotGrob(size_legend_plot)$grobs[[which(sapply(ggplotGrob(size_legend_plot)$grobs, function(x) x$name == "guide-box"))]]
grid.newpage()
grid.draw(ggplotGrob(main_plot))

pushViewport(viewport(x = 0.15, y = 0.45, width = grobWidth(habitat_legend_grob), height = grobHeight(habitat_legend_grob)))
grid.draw(habitat_legend_grob)
popViewport()

pushViewport(viewport(x = 0.65, y = 0.27, width = grobWidth(size_legend_grob), height = grobHeight(size_legend_grob)))
grid.draw(size_legend_grob)
popViewport()

#Stressor co-occurrence pattern####

#Stressor pairs pattern####

factor_stats <- datafull %>% 
  count(FactorPair, name = "Frequency")

factor_pairs <- factor_stats$FactorPair
frequencies <- factor_stats$Frequency

abbreviations <- c("CP" = "Chemical pollutant", "CE" = "CO2 enrichment", 
                   "HS" = "Hydraulic stressors", "IS" = "Invasive species", 
                   "LA" = "Light alterations", "ET" = "Elevated temperature", 
                   "NE" = "Nutrient enrichment")


replace_with_abbr <- function(pair) {
  parts <- strsplit(pair, " x ")[[1]]
  new_parts <- sapply(parts, function(part) names(abbreviations)[abbreviations == part])
  paste(new_parts, collapse = " x ")
}

factor_pairs_abbr <- sapply(factor_pairs, replace_with_abbr, USE.NAMES = FALSE)

data <- data.frame(FactorPair = factor_pairs_abbr, Frequency = frequencies)

data$Factor1 <- sapply(strsplit(as.character(data$FactorPair), " x "), `[`, 1)
data$Factor2 <- sapply(strsplit(as.character(data$FactorPair), " x "), `[`, 2)

factors <- unique(c(data$Factor1, data$Factor2))
n_factors <- length(factors)
matrix <- matrix(0, nrow = n_factors, ncol = n_factors, dimnames = list(factors, factors))

for (i in 1:nrow(data)) {
  matrix[data$Factor1[i], data$Factor2[i]] <- data$Frequency[i]
  matrix[data$Factor2[i], data$Factor1[i]] <- data$Frequency[i]
}

colors <- c("#1a3a9fff","#15638dff","#318288ff","#45a383ff","#69c46eff","#b7da5fff","#fdef9aff")
names(colors) <- factors[1:length(colors)]


layout(matrix(c(1, 2), nrow = 1), widths = c(1, 0.5))

par(mar = c(0, 0, 0, 0))  

circos.par(gap.degree = 3)
chordDiagram(matrix, annotationTrack = c('grid', 'name'),    
             grid.col = colors,   
             preAllocateTracks =  list(track.height = 0.2))

plot.new()
par((mar = c(0,0,0,0)))
legend("right", 
       legend = paste(names(abbreviations), " = ", abbreviations, sep = ""), 
       fill = colors[match(names(abbreviations), factors)], 
       title = "Stressors type", 
       cex = 1, 
       bty = "n", 
       title.adj = 0.5)


# 
colors <- c("#1a3a9fff", "#15638dff", "#318288ff", "#45a383ff", "#69c46eff", "#b7da5fff", "#fdef9aff")

# 2.  factor 
factor_totals <- rowSums(matrix) + colSums(matrix)

# 3. 
factor_order <- names(sort(factor_totals, decreasing = TRUE))

# 4. 
colors_sorted <- colors[1:length(factor_order)]
names(colors_sorted) <- factor_order

# 5. circos
circos.par(gap.degree = 3, start.degree = 135)  #  

# 
layout(matrix(c(1, 2), nrow = 1), widths = c(1, 0.5))
par(mar = c(0, 0, 0, 0))

# 6. 
chordDiagram(
  matrix[factor_order, factor_order],     # 
  grid.col = colors_sorted,               # 
  annotationTrack = c("grid", "name"),
  order = factor_order,                   # sector
  preAllocateTracks = list(track.height = 0.2)
)

# 7. 
plot.new()
par(mar = c(0, 0, 0, 0))
legend(
  "right",
  legend = paste(factor_order, " = ", abbreviations[factor_order]),
  fill = colors_sorted[factor_order],
  title = "Stressors type",
  cex = 1,
  bty = "n",
  title.adj = 0.5
)
#publication bias####
V.add <- impute_covariance_matrix(datafull$VdAdditive,
                                  cluster = datafull$StudyID,
                                  r = 0.6, 
                                  smooth_vi = FALSE,
                                  check_PD = TRUE)

Eggtest.add <- rma.mv(yi=HedgesdAdditive, 
                  V=V.add,
                  data = datafull,
                  mods= VdAdditive,
                  random= c(~1|StudyID/ObservationID),
                  test = "t", 
                  method = "REML"
)


Eggtest.add
coef_test(Eggtest.add,vcov = "CR2", p_values = T)

V.mul <- impute_covariance_matrix(datafull$VdMultiplicative,
                                  cluster = datafull$StudyID,
                                  r = 0.6, 
                                  smooth_vi = FALSE,
                                  check_PD = TRUE)

Eggtest.mul <- rma.mv(yi=HedgesdMultiplicative, 
                      V=V.mul,
                      data = datafull,
                      mods= VdMultiplicative,
                      random= c(~1|StudyID/ObservationID),
                      test = "t", 
                      method = "REML"
)


Eggtest.mul
coef_test(Eggtest.mul,vcov = "CR2", p_values = T)

V.dom <- impute_covariance_matrix(datafull$VdDominance,
                                  cluster = datafull$StudyID,
                                  r = 0.6, 
                                  smooth_vi = FALSE,
                                  check_PD = TRUE)

Eggtest.dom <- rma.mv(yi=HedgesdDominance, 
                      V=V.dom,
                      data = datafull,
                      mods= VdDominance,
                      random= c(~1|StudyID/ObservationID),
                      test = "t", 
                      method = "REML"
)


Eggtest.dom
coef_test(Eggtest.dom,vcov = "CR2", p_values = T)

#Notice: no significant correlation between interaction variance and interaction effect size can be interpreted as no bias

Eggtest2.add <- rma.mv(yi=HedgesdAdditive, 
                   V=V.add,
                   data = datafull,
                   mods=I(1/n_p),
                   random= c(~1|StudyID/ObservationID),
                   test = "t", 
                   method = "REML"
)


Eggtest2.add
coef_test(Eggtest2.add,vcov = "CR2", p_values = T)

Eggtest2.mul <- rma.mv(yi=HedgesdMultiplicative, 
                       V=V.mul,
                       data = datafull,
                       mods=I(1/n_p),
                       random= c(~1|StudyID/ObservationID),
                       test = "t", 
                       method = "REML"
)


Eggtest2.mul
coef_test(Eggtest2.mul,vcov = "CR2", p_values = T)

Eggtest2.dom <- rma.mv(yi=HedgesdDominance, 
                       V=V.dom,
                       data = datafull,
                       mods=I(1/n_p),
                       random= c(~1|StudyID/ObservationID),
                       test = "t", 
                       method = "REML"
)


Eggtest2.dom
coef_test(Eggtest2.dom,vcov = "CR2", p_values = T)

#Notice: no significant correlation between interaction variance and interaction effect size can be interpreted as no bias


#funnel plot
rand.mv <- rma.mv(yi=HedgesdAdditive, 
                  V.add,
                  data = datafull,
                  random= c(~1|StudyID/ObservationID),
                  test = "t", 
                  method = "REML"
                  #struct= "CAR",
                  # rho=0.
)

funnel(rand.mv, 
       main= "Additive null model",
       xlab = "Interaction Effect Size", xlim= c(-20,10),
       cex.lab= 1, refline = 0,
       back = adjustcolor("cornflowerblue", alpha.f = 0.1), 
       col= "cornflowerblue", lwd= 3 
)

rand.mv <- rma.mv(yi=HedgesdMultiplicative, 
                  V.mul,
                  data = datafull,
                  random= c(~1|StudyID/ObservationID),
                  test = "t", 
                  method = "REML"
                  #struct= "CAR",
                  # rho=0.
)

funnel(rand.mv, 
       main= "Multiplicative null model",
       xlab = "Interaction Effect Size", xlim= c(-20,10),
       cex.lab= 1, refline = 0,
       back = adjustcolor("cornflowerblue", alpha.f = 0.1), 
       col= "cornflowerblue", lwd= 3 
)

rand.mv <- rma.mv(yi=HedgesdDominance, 
                  V.dom,
                  data = datafull,
                  random= c(~1|StudyID/ObservationID),
                  test = "t", 
                  method = "REML"
                  #struct= "CAR",
                  # rho=0.
)

funnel(rand.mv, 
       main= "Dominance null model",
       xlab = "Interaction Effect Size", xlim= c(-20,10),
       cex.lab= 1, refline = 0,
       back = adjustcolor("cornflowerblue", alpha.f = 0.1), 
       col= "cornflowerblue", lwd= 3 
)
